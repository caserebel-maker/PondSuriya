<!DOCTYPE html>
<html lang="th">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏£‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô - ‡∏™‡∏°‡∏∏‡∏ó‡∏£‡∏õ‡∏£‡∏≤‡∏Å‡∏≤‡∏£ ‡∏£‡πà‡∏ß‡∏°‡πÉ‡∏à</title>
    <link rel="stylesheet" href="../css/style.css">
    <style>
        .manage-layout {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: var(--space-6);
            padding: var(--space-8);
            background: var(--gray-50);
            min-height: 100vh;
        }

        .card {
            background: white;
            padding: var(--space-6);
            border-radius: var(--radius-xl);
            box-shadow: var(--shadow-sm);
            margin-bottom: var(--space-6);
        }

        .detail-row {
            display: grid;
            grid-template-columns: 150px 1fr;
            margin-bottom: var(--space-4);
        }

        .detail-label {
            color: var(--gray-500);
            font-weight: 500;
        }

        .image-gallery {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: var(--space-4);
            margin-top: var(--space-4);
        }

        .image-item {
            width: 100%;
            height: 150px;
            object-fit: cover;
            border-radius: var(--radius-md);
            cursor: pointer;
        }

        .timeline {
            border-left: 2px solid var(--gray-200);
            padding-left: var(--space-6);
            margin-left: var(--space-2);
        }

        .timeline-item {
            position: relative;
            margin-bottom: var(--space-6);
        }

        .timeline-dot {
            width: 12px;
            height: 12px;
            background: var(--primary-500);
            border-radius: 50%;
            position: absolute;
            left: -23px;
            top: 5px;
        }

        .status-select {
            width: 100%;
            padding: var(--space-3);
            border: 1px solid var(--gray-300);
            border-radius: var(--radius-lg);
            margin-bottom: var(--space-4);
        }

        @media (max-width: 768px) {
            .manage-layout {
                grid-template-columns: 1fr;
                padding: var(--space-4);
            }
        }
    </style>
</head>

<body>
    <!-- Navbar (Simplified for admin) -->
    <nav
        style="background: white; padding: var(--space-4) var(--space-8); border-bottom: 1px solid var(--gray-200); display: flex; justify-content: space-between; align-items: center;">
        <div style="font-weight: bold; font-size: var(--font-size-lg);">‚ö° ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏£‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</div>
        <a href="dashboard.html" class="btn btn-sm btn-secondary">‚Üê ‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤ Dashboard</a>
    </nav>

    <div class="manage-layout">
        <!-- Main Content -->
        <main>
            <!-- Report Details -->
            <div class="card">
                <div style="display: flex; justify-content: space-between; margin-bottom: var(--space-6);">
                    <h2 id="reportTitle">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏£‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</h2>
                    <span id="currentStatus" class="badge">Loading...</span>
                </div>

                <div class="detail-row">
                    <span class="detail-label">Tracking ID</span>
                    <strong id="detail-id">-</strong>
                </div>
                <div class="detail-row">
                    <span class="detail-label">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏à‡πâ‡∏á</span>
                    <span id="detail-date">-</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà</span>
                    <span id="detail-category">-</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">‡∏ú‡∏π‡πâ‡πÅ‡∏à‡πâ‡∏á</span>
                    <span id="detail-name">-</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£</span>
                    <span><a href="#" id="detail-phone">-</a></span>
                </div>

                <hr style="margin: var(--space-6) 0; border: 0; border-top: 1px solid var(--gray-200);">

                <h3 style="margin-bottom: var(--space-4);">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏õ‡∏±‡∏ç‡∏´‡∏≤</h3>
                <p id="detail-desc" style="color: var(--gray-700); line-height: 1.6;">-</p>

                <h4 style="margin-top: var(--space-6); margin-bottom: var(--space-2);">‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà</h4>
                <p id="detail-location">-</p>

                <h4 style="margin-top: var(--space-6); margin-bottom: var(--space-4);">‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö</h4>
                <div class="image-gallery" id="detail-images">
                    <!-- Images will go here -->
                </div>
            </div>

            <!-- Resolution Images (Only if completed) -->
            <div class="card" id="resolutionCard" style="display: none;">
                <h3>üì∏ ‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç (After)</h3>
                <div class="image-gallery" id="resolution-images"></div>
            </div>
        </main>

        <!-- Sidebar / Action Panel -->
        <aside>
            <div class="card">
                <h3 style="margin-bottom: var(--space-4);">‚öôÔ∏è ‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</h3>

                <form id="updateForm">
                    <label class="form-label">‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</label>
                    <select id="statusSelect" class="status-select">
                        <option value="pending">‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö</option>
                        <option value="accepted">‡∏£‡∏±‡∏ö‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÅ‡∏•‡πâ‡∏ß</option>
                        <option value="in_progress">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</option>
                        <option value="completed">‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô</option>
                    </select>

                    <label class="form-label">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</label>
                    <textarea id="actionNote" class="form-input" style="height: 100px; margin-bottom: var(--space-4);"
                        placeholder="‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£..."></textarea>

                    <div id="uploadResolution" style="display: none;">
                        <label class="form-label">‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡∏´‡∏•‡∏±‡∏á‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç (‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô)</label>
                        <input type="file" id="afterImageInput" accept="image/*" class="form-input"
                            style="margin-bottom: var(--space-4);">
                        <div id="afterImagePreview" style="margin-bottom: var(--space-4);"></div>
                    </div>

                    <button type="submit" class="btn btn-primary w-full">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á</button>
                </form>
            </div>

            <div class="card">
                <h3 style="margin-bottom: var(--space-4);">üïí Timeline</h3>
                <div class="timeline" id="timelineList">
                    <!-- Timeline items -->
                </div>
            </div>
        </aside>
    </div>

    <!-- Scripts -->
    <script src="../js/services/auth-service.js"></script>
    <script src="../js/services/db-service.js"></script>
    <script>
        // Auth Check
        authService.checkAuth();

        const urlParams = new URLSearchParams(window.location.search);
        const reportId = urlParams.get('id');

        // Elements
        const form = document.getElementById('updateForm');
        const statusSelect = document.getElementById('statusSelect');
        const uploadDiv = document.getElementById('uploadResolution');

        if (!reportId) {
            alert('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏£‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô');
            window.location.href = 'dashboard.html';
        }

        statusSelect.addEventListener('change', () => {
            if (statusSelect.value === 'completed') {
                uploadDiv.style.display = 'block';
                document.getElementById('afterImageInput').required = true;
            } else {
                uploadDiv.style.display = 'none';
                document.getElementById('afterImageInput').required = false;
            }
        });

        async function loadReport() {
            try {
                const report = await dbService.getReportById(reportId);
                if (!report) throw new Error('Report not found');

                // Render Info
                document.getElementById('detail-id').textContent = report.id;
                document.getElementById('detail-date').textContent = new Date(report.createdAt).toLocaleString('th-TH');
                document.getElementById('detail-category').textContent = report.category;
                document.getElementById('detail-name').textContent = report.name;
                document.getElementById('detail-phone').textContent = report.phone;
                document.getElementById('detail-phone').href = `tel:${report.phone}`;
                document.getElementById('detail-desc').textContent = report.description;
                document.getElementById('detail-location').textContent = `${report.location} (${report.subdistrict} > ${report.district})`;

                // Status Badge
                const sBadge = document.getElementById('currentStatus');
                sBadge.textContent = report.status.toUpperCase();

                // Images
                const imgContainer = document.getElementById('detail-images');
                if (report.images && report.images.length > 0) {
                    report.images.forEach(src => {
                        const img = document.createElement('img');
                        img.src = src;
                        img.className = 'image-item';
                        img.onclick = () => window.open(src, '_blank');
                        imgContainer.appendChild(img);
                    });
                } else {
                    imgContainer.innerHTML = '<p style="color:#999;">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö</p>';
                }

                // Timeline
                const tlContainer = document.getElementById('timelineList');
                tlContainer.innerHTML = '';
                report.timeline.forEach(t => {
                    const div = document.createElement('div');
                    div.className = 'timeline-item';
                    div.innerHTML = `
                        <div class="timeline-dot"></div>
                        <div style="font-weight: 500;">${t.status}</div>
                        <div style="font-size: 0.9em; color: var(--gray-600);">${t.message}</div>
                        <div style="font-size: 0.8em; color: var(--gray-400);">${new Date(t.timestamp).toLocaleString('th-TH')}</div>
                    `;
                    tlContainer.appendChild(div);
                });

                // Set form defaults
                statusSelect.value = report.status;
                if (report.status === 'completed') uploadDiv.style.display = 'block';

            } catch (err) {
                alert('Error: ' + err.message);
                window.location.href = 'dashboard.html';
            }
        }

        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = form.querySelector('button');
            btn.disabled = true;
            btn.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...';

            try {
                const newStatus = statusSelect.value;
                const note = document.getElementById('actionNote').value || '‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞';
                const extraData = {};

                // Handle After Image
                if (newStatus === 'completed') {
                    const fileInput = document.getElementById('afterImageInput');
                    if (fileInput.files.length > 0) {
                        const file = fileInput.files[0];
                        const reader = new FileReader();
                        // Simple promise wrapper for reader
                        const dataUrl = await new Promise(resolve => {
                            reader.onload = e => resolve(e.target.result);
                            reader.readAsDataURL(file);
                        });
                        extraData.afterImages = [dataUrl];
                    }
                }

                await dbService.updateReportStatus(reportId, newStatus, note, extraData);

                alert('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß');
                window.location.reload();

            } catch (err) {
                alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + err.message);
                btn.disabled = false;
                btn.textContent = 'üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á';
            }
        });

        loadReport();
    </script>
</body>

</html>